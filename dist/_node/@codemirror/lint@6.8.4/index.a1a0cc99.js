import{showPanel as ie,EditorView as S,Decoration as x,ViewPlugin as oe,gutter as se,showTooltip as ne,hoverTooltip as le,logException as re,GutterMarker as ae,WidgetType as ce,getPanel as de}from"../view@6.36.4/index.e009e95f.js";import{StateEffect as C,StateField as A,Facet as j,combineConfig as z,RangeSet as I,RangeSetBuilder as fe}from"../state@6.5.2/index.4cdf7d00.js";import p from"../../crelt@1.0.6/index.8ff6b95c.js";class H{constructor(e,o,i){this.from=e,this.to=o,this.diagnostic=i}}class b{constructor(e,o,i){this.diagnostics=e,this.panel=o,this.selected=i}static init(e,o,i){let s=e,n=i.facet(v).markerFilter;n&&(s=n(s,i));let l=e.slice().sort((u,f)=>u.from-f.from||u.to-f.to),a=new fe,r=[],c=0;for(let u=0;;){let f=u==l.length?null:l[u];if(!f&&!r.length)break;let m,w;for(r.length?(m=c,w=r.reduce((d,k)=>Math.min(d,k.to),f&&f.from>m?f.from:1e8)):(m=f.from,w=f.to,r.push(f),u++);u<l.length;){let d=l[u];if(d.from==m&&(d.to>d.from||d.to==m))r.push(d),u++,w=Math.min(d.to,w);else{w=Math.min(d.from,w);break}}let E=J(r);if(r.some(d=>d.from==d.to||d.from==d.to-1&&i.doc.lineAt(d.from).to==d.from))a.add(m,m,x.widget({widget:new ke(E),diagnostics:r.slice()}));else{let d=r.reduce((k,$)=>$.markClass?k+" "+$.markClass:k,"");a.add(m,w,x.mark({class:"cm-lintRange cm-lintRange-"+E+d,diagnostics:r.slice(),inclusiveEnd:r.some(k=>k.to>w)}))}c=w;for(let d=0;d<r.length;d++)r[d].to<=c&&r.splice(d--,1)}let h=a.finish();return new b(h,o,y(h))}}function y(t,e=null,o=0){let i=null;return t.between(o,1e9,(s,n,{spec:l})=>{if(!(e&&l.diagnostics.indexOf(e)<0))if(!i)i=new H(s,n,e||l.diagnostics[0]);else{if(l.diagnostics.indexOf(i.diagnostic)<0)return!1;i=new H(i.from,n,i.diagnostic)}}),i}function V(t,e){let o=e.pos,i=e.end||o,s=t.state.facet(v).hideOn(t,o,i);if(s!=null)return s;let n=t.startState.doc.lineAt(e.pos);return!!(t.effects.some(l=>l.is(T))||t.changes.touchesRange(n.from,Math.max(n.to,i)))}function N(t,e){return t.field(g,!1)?e:e.concat(C.appendConfig.of(te))}function q(t,e){return{effects:N(t,[T.of(e)])}}const T=C.define(),M=C.define(),Y=C.define(),g=A.define({create(){return new b(x.none,null,null)},update(t,e){if(e.docChanged&&t.diagnostics.size){let o=t.diagnostics.map(e.changes),i=null,s=t.panel;if(t.selected){let n=e.changes.mapPos(t.selected.from,1);i=y(o,t.selected.diagnostic,n)||y(o,null,n)}!o.size&&s&&e.state.facet(v).autoPanel&&(s=null),t=new b(o,s,i)}for(let o of e.effects)if(o.is(T)){let i=e.state.facet(v).autoPanel?o.value.length?R.open:null:t.panel;t=b.init(o.value,i,e.state)}else o.is(M)?t=new b(t.diagnostics,o.value?R.open:null,t.selected):o.is(Y)&&(t=new b(t.diagnostics,t.panel,o.value));return t},provide:t=>[ie.from(t,e=>e.panel),S.decorations.from(t,e=>e.diagnostics)]});function ue(t){let e=t.field(g,!1);return e?e.diagnostics.size:0}const me=x.mark({class:"cm-lintRange cm-lintRange-active"});function he(t,e,o){let{diagnostics:i}=t.state.field(g),s,n=-1,l=-1;i.between(e-(o<0?1:0),e+(o>0?1:0),(r,c,{spec:h})=>{if(e>=r&&e<=c&&(r==c||(e>r||o>0)&&(e<c||o<0)))return s=h.diagnostics,n=r,l=c,!1});let a=t.state.facet(v).tooltipFilter;return s&&a&&(s=a(s,t.state)),s?{pos:n,end:l,above:t.state.doc.lineAt(n).to<l,create(){return{dom:Z(t,s)}}}:null}function Z(t,e){return p("ul",{class:"cm-tooltip-lint"},e.map(o=>_(t,o,!1)))}const U=t=>{let e=t.state.field(g,!1);(!e||!e.panel)&&t.dispatch({effects:N(t.state,[M.of(!0)])});let o=de(t,R.open);return o&&o.dom.querySelector(".cm-panel-lint ul").focus(),!0},O=t=>{let e=t.state.field(g,!1);return!e||!e.panel?!1:(t.dispatch({effects:M.of(!1)}),!0)},X=t=>{let e=t.state.field(g,!1);if(!e)return!1;let o=t.state.selection.main,i=e.diagnostics.iter(o.to+1);return!i.value&&(i=e.diagnostics.iter(0),!i.value||i.from==o.from&&i.to==o.to)?!1:(t.dispatch({selection:{anchor:i.from,head:i.to},scrollIntoView:!0}),!0)},ge=t=>{let{state:e}=t,o=e.field(g,!1);if(!o)return!1;let i=e.selection.main,s,n,l,a;return o.diagnostics.between(0,e.doc.length,(r,c)=>{c<i.to&&(s==null||s<r)&&(s=r,n=c),(l==null||r>l)&&(l=r,a=c)}),l==null||s==null&&l==i.from?!1:(t.dispatch({selection:{anchor:s??l,head:n??a},scrollIntoView:!0}),!0)},pe=[{key:"Mod-Shift-m",run:U,preventDefault:!0},{key:"F8",run:X}],K=oe.fromClass(class{constructor(t){this.view=t,this.timeout=-1,this.set=!0;let{delay:e}=t.state.facet(v);this.lintTime=Date.now()+e,this.run=this.run.bind(this),this.timeout=setTimeout(this.run,e)}run(){clearTimeout(this.timeout);let t=Date.now();if(t<this.lintTime-10)this.timeout=setTimeout(this.run,this.lintTime-t);else{this.set=!1;let{state:e}=this.view,{sources:o}=e.facet(v);o.length&&ve(o.map(i=>Promise.resolve(i(this.view))),i=>{this.view.state.doc==e.doc&&this.view.dispatch(q(this.view.state,i.reduce((s,n)=>s.concat(n))))},i=>{re(this.view.state,i)})}}update(t){let e=t.state.facet(v);(t.docChanged||e!=t.startState.facet(v)||e.needsRefresh&&e.needsRefresh(t))&&(this.lintTime=Date.now()+e.delay,this.set||(this.set=!0,this.timeout=setTimeout(this.run,e.delay)))}force(){this.set&&(this.lintTime=Date.now(),this.run())}destroy(){clearTimeout(this.timeout)}});function ve(t,e,o){let i=[],s=-1;for(let n of t)n.then(l=>{i.push(l),clearTimeout(s),i.length==t.length?e(i):s=setTimeout(()=>e(i),200)},o)}const v=j.define({combine(t){return Object.assign({sources:t.map(e=>e.source).filter(e=>e!=null)},z(t.map(e=>e.config),{delay:750,markerFilter:null,tooltipFilter:null,needsRefresh:null,hideOn:()=>null},{needsRefresh:(e,o)=>e?o?i=>e(i)||o(i):e:o}))}});function we(t,e={}){return[v.of({source:t,config:e}),K,te]}function be(t){let e=t.plugin(K);e&&e.force()}function W(t){let e=[];if(t)e:for(let{name:o}of t){for(let i=0;i<o.length;i++){let s=o[i];if(/[a-zA-Z]/.test(s)&&!e.some(n=>n.toLowerCase()==s.toLowerCase())){e.push(s);continue e}}e.push("")}return e}function _(t,e,o){var i;let s=o?W(e.actions):[];return p("li",{class:"cm-diagnostic cm-diagnostic-"+e.severity},p("span",{class:"cm-diagnosticText"},e.renderMessage?e.renderMessage(t):e.message),(i=e.actions)===null||i===void 0?void 0:i.map((n,l)=>{let a=!1,r=f=>{if(f.preventDefault(),a)return;a=!0;let m=y(t.state.field(g).diagnostics,e);m&&n.apply(t,m.from,m.to)},{name:c}=n,h=s[l]?c.indexOf(s[l]):-1,u=h<0?c:[c.slice(0,h),p("u",c.slice(h,h+1)),c.slice(h+1)];return p("button",{type:"button",class:"cm-diagnosticAction",onclick:r,onmousedown:r,"aria-label":` Action: ${c}${h<0?"":` (access key "${s[l]})"`}.`},u)}),e.source&&p("div",{class:"cm-diagnosticSource"},e.source))}class ke extends ce{constructor(e){super(),this.sev=e}eq(e){return e.sev==this.sev}toDOM(){return p("span",{class:"cm-lintPoint cm-lintPoint-"+this.sev})}}class G{constructor(e,o){this.diagnostic=o,this.id="item_"+Math.floor(Math.random()*4294967295).toString(16),this.dom=_(e,o,!0),this.dom.id=this.id,this.dom.setAttribute("role","option")}}class R{constructor(e){this.view=e,this.items=[];let o=s=>{if(s.keyCode==27)O(this.view),this.view.focus();else if(s.keyCode==38||s.keyCode==33)this.moveSelection((this.selectedIndex-1+this.items.length)%this.items.length);else if(s.keyCode==40||s.keyCode==34)this.moveSelection((this.selectedIndex+1)%this.items.length);else if(s.keyCode==36)this.moveSelection(0);else if(s.keyCode==35)this.moveSelection(this.items.length-1);else if(s.keyCode==13)this.view.focus();else if(s.keyCode>=65&&s.keyCode<=90&&this.selectedIndex>=0){let{diagnostic:n}=this.items[this.selectedIndex],l=W(n.actions);for(let a=0;a<l.length;a++)if(l[a].toUpperCase().charCodeAt(0)==s.keyCode){let r=y(this.view.state.field(g).diagnostics,n);r&&n.actions[a].apply(e,r.from,r.to)}}else return;s.preventDefault()},i=s=>{for(let n=0;n<this.items.length;n++)this.items[n].dom.contains(s.target)&&this.moveSelection(n)};this.list=p("ul",{tabIndex:0,role:"listbox","aria-label":this.view.state.phrase("Diagnostics"),onkeydown:o,onclick:i}),this.dom=p("div",{class:"cm-panel-lint"},this.list,p("button",{type:"button",name:"close","aria-label":this.view.state.phrase("close"),onclick:()=>O(this.view)},"\xD7")),this.update()}get selectedIndex(){let e=this.view.state.field(g).selected;if(!e)return-1;for(let o=0;o<this.items.length;o++)if(this.items[o].diagnostic==e.diagnostic)return o;return-1}update(){let{diagnostics:e,selected:o}=this.view.state.field(g),i=0,s=!1,n=null,l=new Set;for(e.between(0,this.view.state.doc.length,(a,r,{spec:c})=>{for(let h of c.diagnostics){if(l.has(h))continue;l.add(h);let u=-1,f;for(let m=i;m<this.items.length;m++)if(this.items[m].diagnostic==h){u=m;break}u<0?(f=new G(this.view,h),this.items.splice(i,0,f),s=!0):(f=this.items[u],u>i&&(this.items.splice(i,u-i),s=!0)),o&&f.diagnostic==o.diagnostic?f.dom.hasAttribute("aria-selected")||(f.dom.setAttribute("aria-selected","true"),n=f):f.dom.hasAttribute("aria-selected")&&f.dom.removeAttribute("aria-selected"),i++}});i<this.items.length&&!(this.items.length==1&&this.items[0].diagnostic.from<0);)s=!0,this.items.pop();this.items.length==0&&(this.items.push(new G(this.view,{from:-1,to:-1,severity:"info",message:this.view.state.phrase("No diagnostics")})),s=!0),n?(this.list.setAttribute("aria-activedescendant",n.id),this.view.requestMeasure({key:this,read:()=>({sel:n.dom.getBoundingClientRect(),panel:this.list.getBoundingClientRect()}),write:({sel:a,panel:r})=>{let c=r.height/this.list.offsetHeight;a.top<r.top?this.list.scrollTop-=(r.top-a.top)/c:a.bottom>r.bottom&&(this.list.scrollTop+=(a.bottom-r.bottom)/c)}})):this.selectedIndex<0&&this.list.removeAttribute("aria-activedescendant"),s&&this.sync()}sync(){let e=this.list.firstChild;function o(){let i=e;e=i.nextSibling,i.remove()}for(let i of this.items)if(i.dom.parentNode==this.list){for(;e!=i.dom;)o();e=i.dom.nextSibling}else this.list.insertBefore(i.dom,e);for(;e;)o()}moveSelection(e){if(this.selectedIndex<0)return;let o=this.view.state.field(g),i=y(o.diagnostics,this.items[e].diagnostic);i&&this.view.dispatch({selection:{anchor:i.from,head:i.to},scrollIntoView:!0,effects:Y.of(i)})}static open(e){return new R(e)}}function L(t,e='viewBox="0 0 40 40"'){return`url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" ${e}>${encodeURIComponent(t)}</svg>')`}function D(t){return L(`<path d="m0 2.5 l2 -1.5 l1 0 l2 1.5 l1 0" stroke="${t}" fill="none" stroke-width=".7"/>`,'width="6" height="3"')}const xe=S.baseTheme({".cm-diagnostic":{padding:"3px 6px 3px 8px",marginLeft:"-1px",display:"block",whiteSpace:"pre-wrap"},".cm-diagnostic-error":{borderLeft:"5px solid #d11"},".cm-diagnostic-warning":{borderLeft:"5px solid orange"},".cm-diagnostic-info":{borderLeft:"5px solid #999"},".cm-diagnostic-hint":{borderLeft:"5px solid #66d"},".cm-diagnosticAction":{font:"inherit",border:"none",padding:"2px 4px",backgroundColor:"#444",color:"white",borderRadius:"3px",marginLeft:"8px",cursor:"pointer"},".cm-diagnosticSource":{fontSize:"70%",opacity:.7},".cm-lintRange":{backgroundPosition:"left bottom",backgroundRepeat:"repeat-x",paddingBottom:"0.7px"},".cm-lintRange-error":{backgroundImage:D("#d11")},".cm-lintRange-warning":{backgroundImage:D("orange")},".cm-lintRange-info":{backgroundImage:D("#999")},".cm-lintRange-hint":{backgroundImage:D("#66d")},".cm-lintRange-active":{backgroundColor:"#ffdd9980"},".cm-tooltip-lint":{padding:0,margin:0},".cm-lintPoint":{position:"relative","&:after":{content:'""',position:"absolute",bottom:0,left:"-2px",borderLeft:"3px solid transparent",borderRight:"3px solid transparent",borderBottom:"4px solid #d11"}},".cm-lintPoint-warning":{"&:after":{borderBottomColor:"orange"}},".cm-lintPoint-info":{"&:after":{borderBottomColor:"#999"}},".cm-lintPoint-hint":{"&:after":{borderBottomColor:"#66d"}},".cm-panel.cm-panel-lint":{position:"relative","& ul":{maxHeight:"100px",overflowY:"auto","& [aria-selected]":{backgroundColor:"#ddd","& u":{textDecoration:"underline"}},"&:focus [aria-selected]":{background_fallback:"#bdf",backgroundColor:"Highlight",color_fallback:"white",color:"HighlightText"},"& u":{textDecoration:"none"},padding:0,margin:0},"& [name=close]":{position:"absolute",top:"0",right:"2px",background:"inherit",border:"none",font:"inherit",padding:0,margin:0}}});function ye(t){return t=="error"?4:t=="warning"?3:t=="info"?2:1}function J(t){let e="hint",o=1;for(let i of t){let s=ye(i.severity);s>o&&(o=s,e=i.severity)}return e}class Q extends ae{constructor(e){super(),this.diagnostics=e,this.severity=J(e)}toDOM(e){let o=document.createElement("div");o.className="cm-lint-marker cm-lint-marker-"+this.severity;let i=this.diagnostics,s=e.state.facet(P).tooltipFilter;return s&&(i=s(i,e.state)),i.length&&(o.onmouseover=()=>Te(e,o,i)),o}}function Ce(t,e){let o=i=>{let s=e.getBoundingClientRect();if(!(i.clientX>s.left-10&&i.clientX<s.right+10&&i.clientY>s.top-10&&i.clientY<s.bottom+10)){for(let n=i.target;n;n=n.parentNode)if(n.nodeType==1&&n.classList.contains("cm-tooltip-lint"))return;window.removeEventListener("mousemove",o),t.state.field(ee)&&t.dispatch({effects:F.of(null)})}};window.addEventListener("mousemove",o)}function Te(t,e,o){function i(){let l=t.elementAtHeight(e.getBoundingClientRect().top+5-t.documentTop);t.coordsAtPos(l.from)&&t.dispatch({effects:F.of({pos:l.from,above:!1,clip:!1,create(){return{dom:Z(t,o),getCoords:()=>e.getBoundingClientRect()}}})}),e.onmouseout=e.onmousemove=null,Ce(t,e)}let{hoverTime:s}=t.state.facet(P),n=setTimeout(i,s);e.onmouseout=()=>{clearTimeout(n),e.onmouseout=e.onmousemove=null},e.onmousemove=()=>{clearTimeout(n),n=setTimeout(i,s)}}function Re(t,e){let o=Object.create(null);for(let s of e){let n=t.lineAt(s.from);(o[n.from]||(o[n.from]=[])).push(s)}let i=[];for(let s in o)i.push(new Q(o[s]).range(+s));return I.of(i,!0)}const Se=se({class:"cm-gutter-lint",markers:t=>t.state.field(B),widgetMarker:(t,e,o)=>{let i=[];return t.state.field(B).between(o.from,o.to,(s,n,l)=>{s>o.from&&s<o.to&&i.push(...l.diagnostics)}),i.length?new Q(i):null}}),B=A.define({create(){return I.empty},update(t,e){t=t.map(e.changes);let o=e.state.facet(P).markerFilter;for(let i of e.effects)if(i.is(T)){let s=i.value;o&&(s=o(s||[],e.state)),t=Re(e.state.doc,s.slice(0))}return t}}),F=C.define(),ee=A.define({create(){return null},update(t,e){return t&&e.docChanged&&(t=V(e,t)?null:Object.assign(Object.assign({},t),{pos:e.changes.mapPos(t.pos)})),e.effects.reduce((o,i)=>i.is(F)?i.value:o,t)},provide:t=>ne.from(t)}),Le=S.baseTheme({".cm-gutter-lint":{width:"1.4em","& .cm-gutterElement":{padding:".2em"}},".cm-lint-marker":{width:"1em",height:"1em"},".cm-lint-marker-info":{content:L('<path fill="#aaf" stroke="#77e" stroke-width="6" stroke-linejoin="round" d="M5 5L35 5L35 35L5 35Z"/>')},".cm-lint-marker-warning":{content:L('<path fill="#fe8" stroke="#fd7" stroke-width="6" stroke-linejoin="round" d="M20 6L37 35L3 35Z"/>')},".cm-lint-marker-error":{content:L('<circle cx="20" cy="20" r="15" fill="#f87" stroke="#f43" stroke-width="6"/>')}}),te=[g,S.decorations.compute([g],t=>{let{selected:e,panel:o}=t.field(g);return!e||!o||e.from==e.to?x.none:x.set([me.range(e.from,e.to)])}),le(he,{hideOn:V}),xe],P=j.define({combine(t){return z(t,{hoverTime:300,markerFilter:null,tooltipFilter:null})}});function De(t={}){return[P.of(t),B,Se,Le,ee]}function Pe(t,e){let o=t.field(g,!1);if(o&&o.diagnostics.size){let i=[],s=[],n=-1;for(let l=I.iter([o.diagnostics]);;l.next()){for(let a=0;a<i.length;a++)(!l.value||l.value.spec.diagnostics.indexOf(i[a])<0)&&(e(i[a],s[a],n),i.splice(a,1),s.splice(a--,1));if(!l.value)break;for(let a of l.value.spec.diagnostics)i.indexOf(a)<0&&(i.push(a),s.push(l.from));n=l.to}}}export{O as closeLintPanel,ue as diagnosticCount,Pe as forEachDiagnostic,be as forceLinting,De as lintGutter,pe as lintKeymap,we as linter,X as nextDiagnostic,U as openLintPanel,ge as previousDiagnostic,q as setDiagnostics,T as setDiagnosticsEffect};
