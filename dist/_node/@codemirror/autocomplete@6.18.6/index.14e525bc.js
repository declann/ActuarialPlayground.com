import{Annotation as Qt,StateEffect as k,Facet as ht,combineConfig as Xt,StateField as X,Prec as Y,MapMode as G,RangeValue as Yt,RangeSet as Gt,codePointSize as D,codePointAt as C,EditorSelection as w,CharCategory as J,fromCodePoint as ut,Transaction as Jt,Text as Zt}from"../state@6.5.2/index.4cdf7d00.js";import{Direction as _t,showTooltip as te,EditorView as E,ViewPlugin as ee,logException as Z,getTooltip as pt,Decoration as U,WidgetType as ne,keymap as dt}from"../view@6.36.4/index.e009e95f.js";import{syntaxTree as R,indentUnit as oe}from"../language@6.10.8/index.4544127e.js";class _{constructor(t,e,o,s){this.state=t,this.pos=e,this.explicit=o,this.view=s,this.abortListeners=[],this.abortOnDocChange=!1}tokenBefore(t){let e=R(this.state).resolveInner(this.pos,-1);for(;e&&t.indexOf(e.name)<0;)e=e.parent;return e?{from:e.from,to:this.pos,text:this.state.sliceDoc(e.from,this.pos),type:e.type}:null}matchBefore(t){let e=this.state.doc.lineAt(this.pos),o=Math.max(e.from,this.pos-250),s=e.text.slice(o-e.from,this.pos-e.from),i=s.search(bt(t,!1));return i<0?null:{from:o+i,to:this.pos,text:s.slice(i)}}get aborted(){return this.abortListeners==null}addEventListener(t,e,o){t=="abort"&&this.abortListeners&&(this.abortListeners.push(e),o&&o.onDocChange&&(this.abortOnDocChange=!0))}}function mt(n){let t=Object.keys(n).join(""),e=/\w/.test(t);return e&&(t=t.replace(/\w/g,"")),`[${e?"\\w":""}${t.replace(/[^\w\s]/g,"\\$&")}]`}function se(n){let t=Object.create(null),e=Object.create(null);for(let{label:s}of n){t[s[0]]=!0;for(let i=1;i<s.length;i++)e[s[i]]=!0}let o=mt(t)+mt(e)+"*$";return[new RegExp("^"+o),new RegExp(o)]}function gt(n){let t=n.map(s=>typeof s=="string"?{label:s}:s),[e,o]=t.every(s=>/^\w+$/.test(s.label))?[/\w*$/,/\w+$/]:se(t);return s=>{let i=s.matchBefore(o);return i||s.explicit?{from:i?i.from:s.pos,options:t,validFor:e}:null}}function ie(n,t){return e=>{for(let o=R(e.state).resolveInner(e.pos,-1);o;o=o.parent){if(n.indexOf(o.name)>-1)return t(e);if(o.type.isTop)break}return null}}function le(n,t){return e=>{for(let o=R(e.state).resolveInner(e.pos,-1);o;o=o.parent){if(n.indexOf(o.name)>-1)return null;if(o.type.isTop)break}return t(e)}}class vt{constructor(t,e,o,s){this.completion=t,this.source=e,this.match=o,this.score=s}}function O(n){return n.selection.main.from}function bt(n,t){var e;let{source:o}=n,s=t&&o[0]!="^",i=o[o.length-1]!="$";return!s&&!i?n:new RegExp(`${s?"^":""}(?:${o})${i?"$":""}`,(e=n.flags)!==null&&e!==void 0?e:n.ignoreCase?"i":"")}const q=Qt.define();function yt(n,t,e,o){let{main:s}=n.selection,i=e-s.from,r=o-s.from;return Object.assign(Object.assign({},n.changeByRange(l=>{if(l!=s&&e!=o&&n.sliceDoc(l.from+i,l.from+r)!=n.sliceDoc(e,o))return{range:l};let a=n.toText(t);return{changes:{from:l.from+i,to:o==s.from?l.to:l.from+r,insert:a},range:w.cursor(l.from+i+a.length)}})),{scrollIntoView:!0,userEvent:"input.complete"})}const wt=new WeakMap;function re(n){if(!Array.isArray(n))return n;let t=wt.get(n);return t||wt.set(n,t=gt(n)),t}const H=k.define(),M=k.define();class ae{constructor(t){this.pattern=t,this.chars=[],this.folded=[],this.any=[],this.precise=[],this.byWord=[],this.score=0,this.matched=[];for(let e=0;e<t.length;){let o=C(t,e),s=D(o);this.chars.push(o);let i=t.slice(e,e+s),r=i.toUpperCase();this.folded.push(C(r==i?i.toLowerCase():r,0)),e+=s}this.astral=t.length!=this.chars.length}ret(t,e){return this.score=t,this.matched=e,this}match(t){if(this.pattern.length==0)return this.ret(-100,[]);if(t.length<this.pattern.length)return null;let{chars:e,folded:o,any:s,precise:i,byWord:r}=this;if(e.length==1){let d=C(t,0),A=D(d),I=A==t.length?0:-100;if(d!=e[0])if(d==o[0])I+=-200;else return null;return this.ret(I,[0,A])}let l=t.indexOf(this.pattern);if(l==0)return this.ret(t.length==this.pattern.length?0:-100,[0,this.pattern.length]);let a=e.length,f=0;if(l<0){for(let d=0,A=Math.min(t.length,200);d<A&&f<a;){let I=C(t,d);(I==e[f]||I==o[f])&&(s[f++]=d),d+=D(I)}if(f<a)return null}let c=0,h=0,u=!1,p=0,v=-1,y=-1,z=/[a-z]/.test(t),F=!0;for(let d=0,A=Math.min(t.length,200),I=0;d<A&&h<a;){let b=C(t,d);l<0&&(c<a&&b==e[c]&&(i[c++]=d),p<a&&(b==e[p]||b==o[p]?(p==0&&(v=d),y=d+1,p++):p=0));let W,Q=b<255?b>=48&&b<=57||b>=97&&b<=122?2:b>=65&&b<=90?1:0:(W=ut(b))!=W.toLowerCase()?1:W!=W.toUpperCase()?2:0;(!d||Q==1&&z||I==0&&Q!=0)&&(e[h]==b||o[h]==b&&(u=!0)?r[h++]=d:r.length&&(F=!1)),I=Q,d+=D(b)}return h==a&&r[0]==0&&F?this.result(-100+(u?-200:0),r,t):p==a&&v==0?this.ret(-200-t.length+(y==t.length?0:-100),[0,y]):l>-1?this.ret(-700-t.length,[l,l+this.pattern.length]):p==a?this.ret(-900-t.length,[v,y]):h==a?this.result(-100+(u?-200:0)+-700+(F?0:-1100),r,t):e.length==2?null:this.result((s[0]?-700:0)+-200+-1100,s,t)}result(t,e,o){let s=[],i=0;for(let r of e){let l=r+(this.astral?D(C(o,r)):1);i&&s[i-1]==r?s[i-1]=l:(s[i++]=r,s[i++]=l)}return this.ret(t-o.length,s)}}class ce{constructor(t){this.pattern=t,this.matched=[],this.score=0,this.folded=t.toLowerCase()}match(t){if(t.length<this.pattern.length)return null;let e=t.slice(0,this.pattern.length),o=e==this.pattern?0:e.toLowerCase()==this.folded?-200:null;return o==null?null:(this.matched=[0,e.length],this.score=o+(t.length==this.pattern.length?0:-100),this)}}const m=ht.define({combine(n){return Xt(n,{activateOnTyping:!0,activateOnCompletion:()=>!1,activateOnTypingDelay:100,selectOnOpen:!0,override:null,closeOnBlur:!0,maxRenderedOptions:100,defaultKeymap:!0,tooltipClass:()=>"",optionClass:()=>"",aboveCursor:!1,icons:!0,addToOptions:[],positionInfo:fe,filterStrict:!1,compareCompletions:(t,e)=>t.label.localeCompare(e.label),interactionDelay:75,updateSyncTime:100},{defaultKeymap:(t,e)=>t&&e,closeOnBlur:(t,e)=>t&&e,icons:(t,e)=>t&&e,tooltipClass:(t,e)=>o=>xt(t(o),e(o)),optionClass:(t,e)=>o=>xt(t(o),e(o)),addToOptions:(t,e)=>t.concat(e),filterStrict:(t,e)=>t||e})}});function xt(n,t){return n?t?n+" "+t:n:t}function fe(n,t,e,o,s,i){let r=n.textDirection==_t.RTL,l=r,a=!1,f="top",c,h,u=t.left-s.left,p=s.right-t.right,v=o.right-o.left,y=o.bottom-o.top;if(l&&u<Math.min(v,p)?l=!1:!l&&p<Math.min(v,u)&&(l=!0),v<=(l?u:p))c=Math.max(s.top,Math.min(e.top,s.bottom-y))-t.top,h=Math.min(400,l?u:p);else{a=!0,h=Math.min(400,(r?t.right:s.right-t.left)-30);let d=s.bottom-t.bottom;d>=y||d>t.top?c=e.bottom-t.top:(f="bottom",c=t.bottom-e.top)}let z=(t.bottom-t.top)/i.offsetHeight,F=(t.right-t.left)/i.offsetWidth;return{style:`${f}: ${c/z}px; max-width: ${h/F}px`,class:"cm-completionInfo-"+(a?r?"left-narrow":"right-narrow":l?"left":"right")}}function he(n){let t=n.addToOptions.slice();return n.icons&&t.push({render(e){let o=document.createElement("div");return o.classList.add("cm-completionIcon"),e.type&&o.classList.add(...e.type.split(/\s+/g).map(s=>"cm-completionIcon-"+s)),o.setAttribute("aria-hidden","true"),o},position:20}),t.push({render(e,o,s,i){let r=document.createElement("span");r.className="cm-completionLabel";let l=e.displayLabel||e.label,a=0;for(let f=0;f<i.length;){let c=i[f++],h=i[f++];c>a&&r.appendChild(document.createTextNode(l.slice(a,c)));let u=r.appendChild(document.createElement("span"));u.appendChild(document.createTextNode(l.slice(c,h))),u.className="cm-completionMatchedText",a=h}return a<l.length&&r.appendChild(document.createTextNode(l.slice(a))),r},position:50},{render(e){if(!e.detail)return null;let o=document.createElement("span");return o.className="cm-completionDetail",o.textContent=e.detail,o},position:80}),t.sort((e,o)=>e.position-o.position).map(e=>e.render)}function tt(n,t,e){if(n<=e)return{from:0,to:n};if(t<0&&(t=0),t<=n>>1){let s=Math.floor(t/e);return{from:s*e,to:(s+1)*e}}let o=Math.floor((n-t)/e);return{from:n-(o+1)*e,to:n-o*e}}class ue{constructor(t,e,o){this.view=t,this.stateField=e,this.applyCompletion=o,this.info=null,this.infoDestroy=null,this.placeInfoReq={read:()=>this.measureInfo(),write:a=>this.placeInfo(a),key:this},this.space=null,this.currentClass="";let s=t.state.field(e),{options:i,selected:r}=s.open,l=t.state.facet(m);this.optionContent=he(l),this.optionClass=l.optionClass,this.tooltipClass=l.tooltipClass,this.range=tt(i.length,r,l.maxRenderedOptions),this.dom=document.createElement("div"),this.dom.className="cm-tooltip-autocomplete",this.updateTooltipClass(t.state),this.dom.addEventListener("mousedown",a=>{let{options:f}=t.state.field(e).open;for(let c=a.target,h;c&&c!=this.dom;c=c.parentNode)if(c.nodeName=="LI"&&(h=/-(\d+)$/.exec(c.id))&&+h[1]<f.length){this.applyCompletion(t,f[+h[1]]),a.preventDefault();return}}),this.dom.addEventListener("focusout",a=>{let f=t.state.field(this.stateField,!1);f&&f.tooltip&&t.state.facet(m).closeOnBlur&&a.relatedTarget!=t.contentDOM&&t.dispatch({effects:M.of(null)})}),this.showOptions(i,s.id)}mount(){this.updateSel()}showOptions(t,e){this.list&&this.list.remove(),this.list=this.dom.appendChild(this.createListBox(t,e,this.range)),this.list.addEventListener("scroll",()=>{this.info&&this.view.requestMeasure(this.placeInfoReq)})}update(t){var e;let o=t.state.field(this.stateField),s=t.startState.field(this.stateField);if(this.updateTooltipClass(t.state),o!=s){let{options:i,selected:r,disabled:l}=o.open;(!s.open||s.open.options!=i)&&(this.range=tt(i.length,r,t.state.facet(m).maxRenderedOptions),this.showOptions(i,o.id)),this.updateSel(),l!=((e=s.open)===null||e===void 0?void 0:e.disabled)&&this.dom.classList.toggle("cm-tooltip-autocomplete-disabled",!!l)}}updateTooltipClass(t){let e=this.tooltipClass(t);if(e!=this.currentClass){for(let o of this.currentClass.split(" "))o&&this.dom.classList.remove(o);for(let o of e.split(" "))o&&this.dom.classList.add(o);this.currentClass=e}}positioned(t){this.space=t,this.info&&this.view.requestMeasure(this.placeInfoReq)}updateSel(){let t=this.view.state.field(this.stateField),e=t.open;if((e.selected>-1&&e.selected<this.range.from||e.selected>=this.range.to)&&(this.range=tt(e.options.length,e.selected,this.view.state.facet(m).maxRenderedOptions),this.showOptions(e.options,t.id)),this.updateSelectedOption(e.selected)){this.destroyInfo();let{completion:o}=e.options[e.selected],{info:s}=o;if(!s)return;let i=typeof s=="string"?document.createTextNode(s):s(o);if(!i)return;"then"in i?i.then(r=>{r&&this.view.state.field(this.stateField,!1)==t&&this.addInfoPane(r,o)}).catch(r=>Z(this.view.state,r,"completion info")):this.addInfoPane(i,o)}}addInfoPane(t,e){this.destroyInfo();let o=this.info=document.createElement("div");if(o.className="cm-tooltip cm-completionInfo",t.nodeType!=null)o.appendChild(t),this.infoDestroy=null;else{let{dom:s,destroy:i}=t;o.appendChild(s),this.infoDestroy=i||null}this.dom.appendChild(o),this.view.requestMeasure(this.placeInfoReq)}updateSelectedOption(t){let e=null;for(let o=this.list.firstChild,s=this.range.from;o;o=o.nextSibling,s++)o.nodeName!="LI"||!o.id?s--:s==t?o.hasAttribute("aria-selected")||(o.setAttribute("aria-selected","true"),e=o):o.hasAttribute("aria-selected")&&o.removeAttribute("aria-selected");return e&&de(this.list,e),e}measureInfo(){let t=this.dom.querySelector("[aria-selected]");if(!t||!this.info)return null;let e=this.dom.getBoundingClientRect(),o=this.info.getBoundingClientRect(),s=t.getBoundingClientRect(),i=this.space;if(!i){let r=this.dom.ownerDocument.documentElement;i={left:0,top:0,right:r.clientWidth,bottom:r.clientHeight}}return s.top>Math.min(i.bottom,e.bottom)-10||s.bottom<Math.max(i.top,e.top)+10?null:this.view.state.facet(m).positionInfo(this.view,e,s,o,i,this.dom)}placeInfo(t){this.info&&(t?(t.style&&(this.info.style.cssText=t.style),this.info.className="cm-tooltip cm-completionInfo "+(t.class||"")):this.info.style.cssText="top: -1e6px")}createListBox(t,e,o){const s=document.createElement("ul");s.id=e,s.setAttribute("role","listbox"),s.setAttribute("aria-expanded","true"),s.setAttribute("aria-label",this.view.state.phrase("Completions")),s.addEventListener("mousedown",r=>{r.target==s&&r.preventDefault()});let i=null;for(let r=o.from;r<o.to;r++){let{completion:l,match:a}=t[r],{section:f}=l;if(f){let u=typeof f=="string"?f:f.name;if(u!=i&&(r>o.from||o.from==0))if(i=u,typeof f!="string"&&f.header)s.appendChild(f.header(f));else{let p=s.appendChild(document.createElement("completion-section"));p.textContent=u}}const c=s.appendChild(document.createElement("li"));c.id=e+"-"+r,c.setAttribute("role","option");let h=this.optionClass(l);h&&(c.className=h);for(let u of this.optionContent){let p=u(l,this.view.state,this.view,a);p&&c.appendChild(p)}}return o.from&&s.classList.add("cm-completionListIncompleteTop"),o.to<t.length&&s.classList.add("cm-completionListIncompleteBottom"),s}destroyInfo(){this.info&&(this.infoDestroy&&this.infoDestroy(),this.info.remove(),this.info=null)}destroy(){this.destroyInfo()}}function pe(n,t){return e=>new ue(e,n,t)}function de(n,t){let e=n.getBoundingClientRect(),o=t.getBoundingClientRect(),s=e.height/n.offsetHeight;o.top<e.top?n.scrollTop-=(e.top-o.top)/s:o.bottom>e.bottom&&(n.scrollTop+=(o.bottom-e.bottom)/s)}function Ct(n){return(n.boost||0)*100+(n.apply?10:0)+(n.info?5:0)+(n.type?1:0)}function me(n,t){let e=[],o=null,s=f=>{e.push(f);let{section:c}=f.completion;if(c){o||(o=[]);let h=typeof c=="string"?c:c.name;o.some(u=>u.name==h)||o.push(typeof c=="string"?{name:h}:c)}},i=t.facet(m);for(let f of n)if(f.hasResult()){let c=f.result.getMatch;if(f.result.filter===!1)for(let h of f.result.options)s(new vt(h,f.source,c?c(h):[],1e9-e.length));else{let h=t.sliceDoc(f.from,f.to),u,p=i.filterStrict?new ce(h):new ae(h);for(let v of f.result.options)if(u=p.match(v.label)){let y=v.displayLabel?c?c(v,u.matched):[]:u.matched;s(new vt(v,f.source,y,u.score+(v.boost||0)))}}}if(o){let f=Object.create(null),c=0,h=(u,p)=>{var v,y;return((v=u.rank)!==null&&v!==void 0?v:1e9)-((y=p.rank)!==null&&y!==void 0?y:1e9)||(u.name<p.name?-1:1)};for(let u of o.sort(h))c-=1e5,f[u.name]=c;for(let u of e){let{section:p}=u.completion;p&&(u.score+=f[typeof p=="string"?p:p.name])}}let r=[],l=null,a=i.compareCompletions;for(let f of e.sort((c,h)=>h.score-c.score||a(c.completion,h.completion))){let c=f.completion;!l||l.label!=c.label||l.detail!=c.detail||l.type!=null&&c.type!=null&&l.type!=c.type||l.apply!=c.apply||l.boost!=c.boost?r.push(f):Ct(f.completion)>Ct(l)&&(r[r.length-1]=f),l=f.completion}return r}class B{constructor(t,e,o,s,i,r){this.options=t,this.attrs=e,this.tooltip=o,this.timestamp=s,this.selected=i,this.disabled=r}setSelected(t,e){return t==this.selected||t>=this.options.length?this:new B(this.options,It(e,t),this.tooltip,this.timestamp,t,this.disabled)}static build(t,e,o,s,i,r){if(s&&!r&&t.some(f=>f.isPending))return s.setDisabled();let l=me(t,e);if(!l.length)return s&&t.some(f=>f.isPending)?s.setDisabled():null;let a=e.facet(m).selectOnOpen?0:-1;if(s&&s.selected!=a&&s.selected!=-1){let f=s.options[s.selected].completion;for(let c=0;c<l.length;c++)if(l[c].completion==f){a=c;break}}return new B(l,It(o,a),{pos:t.reduce((f,c)=>c.hasResult()?Math.min(f,c.from):f,1e8),create:xe,above:i.aboveCursor},s?s.timestamp:Date.now(),a,!1)}map(t){return new B(this.options,this.attrs,Object.assign(Object.assign({},this.tooltip),{pos:t.mapPos(this.tooltip.pos)}),this.timestamp,this.selected,this.disabled)}setDisabled(){return new B(this.options,this.attrs,this.tooltip,this.timestamp,this.selected,!0)}}class K{constructor(t,e,o){this.active=t,this.id=e,this.open=o}static start(){return new K(ye,"cm-ac-"+Math.floor(Math.random()*2e6).toString(36),null)}update(t){let{state:e}=t,o=e.facet(m),s=(o.override||e.languageDataAt("autocomplete",O(e)).map(re)).map(l=>(this.active.find(a=>a.source==l)||new x(l,this.active.some(a=>a.state!=0)?1:0)).update(t,o));s.length==this.active.length&&s.every((l,a)=>l==this.active[a])&&(s=this.active);let i=this.open,r=t.effects.some(l=>l.is(et));i&&t.docChanged&&(i=i.map(t.changes)),t.selection||s.some(l=>l.hasResult()&&t.changes.touchesRange(l.from,l.to))||!ge(s,this.active)||r?i=B.build(s,e,this.id,i,o,r):i&&i.disabled&&!s.some(l=>l.isPending)&&(i=null),!i&&s.every(l=>!l.isPending)&&s.some(l=>l.hasResult())&&(s=s.map(l=>l.hasResult()?new x(l.source,0):l));for(let l of t.effects)l.is(nt)&&(i=i&&i.setSelected(l.value,this.id));return s==this.active&&i==this.open?this:new K(s,this.id,i)}get tooltip(){return this.open?this.open.tooltip:null}get attrs(){return this.open?this.open.attrs:this.active.length?ve:be}}function ge(n,t){if(n==t)return!0;for(let e=0,o=0;;){for(;e<n.length&&!n[e].hasResult();)e++;for(;o<t.length&&!t[o].hasResult();)o++;let s=e==n.length,i=o==t.length;if(s||i)return s==i;if(n[e++].result!=t[o++].result)return!1}}const ve={"aria-autocomplete":"list"},be={};function It(n,t){let e={"aria-autocomplete":"list","aria-haspopup":"listbox","aria-controls":n};return t>-1&&(e["aria-activedescendant"]=n+"-"+t),e}const ye=[];function kt(n,t){if(n.isUserEvent("input.complete")){let o=n.annotation(q);if(o&&t.activateOnCompletion(o))return 12}let e=n.isUserEvent("input.type");return e&&t.activateOnTyping?5:e?1:n.isUserEvent("delete.backward")?2:n.selection?8:n.docChanged?16:0}class x{constructor(t,e,o=!1){this.source=t,this.state=e,this.explicit=o}hasResult(){return!1}get isPending(){return this.state==1}update(t,e){let o=kt(t,e),s=this;(o&8||o&16&&this.touches(t))&&(s=new x(s.source,0)),o&4&&s.state==0&&(s=new x(this.source,1)),s=s.updateFor(t,o);for(let i of t.effects)if(i.is(H))s=new x(s.source,1,i.value);else if(i.is(M))s=new x(s.source,0);else if(i.is(et))for(let r of i.value)r.source==s.source&&(s=r);return s}updateFor(t,e){return this.map(t.changes)}map(t){return this}touches(t){return t.changes.touchesRange(O(t.state))}}class L extends x{constructor(t,e,o,s,i,r){super(t,3,e),this.limit=o,this.result=s,this.from=i,this.to=r}hasResult(){return!0}updateFor(t,e){var o;if(!(e&3))return this.map(t.changes);let s=this.result;s.map&&!t.changes.empty&&(s=s.map(s,t.changes));let i=t.changes.mapPos(this.from),r=t.changes.mapPos(this.to,1),l=O(t.state);if(l>r||!s||e&2&&(O(t.startState)==this.from||l<this.limit))return new x(this.source,e&4?1:0);let a=t.changes.mapPos(this.limit);return we(s.validFor,t.state,i,r)?new L(this.source,this.explicit,a,s,i,r):s.update&&(s=s.update(s,i,r,new _(t.state,l,!1)))?new L(this.source,this.explicit,a,s,s.from,(o=s.to)!==null&&o!==void 0?o:O(t.state)):new x(this.source,1,this.explicit)}map(t){return t.empty?this:(this.result.map?this.result.map(this.result,t):this.result)?new L(this.source,this.explicit,t.mapPos(this.limit),this.result,t.mapPos(this.from),t.mapPos(this.to,1)):new x(this.source,0)}touches(t){return t.changes.touchesRange(this.from,this.to)}}function we(n,t,e,o){if(!n)return!1;let s=t.sliceDoc(e,o);return typeof n=="function"?n(s,e,o,t):bt(n,!0).test(s)}const et=k.define({map(n,t){return n.map(e=>e.map(t))}}),nt=k.define(),g=X.define({create(){return K.start()},update(n,t){return n.update(t)},provide:n=>[te.from(n,t=>t.tooltip),E.contentAttributes.from(n,t=>t.attrs)]});function ot(n,t){const e=t.completion.apply||t.completion.label;let o=n.state.field(g).active.find(s=>s.source==t.source);return o instanceof L?(typeof e=="string"?n.dispatch(Object.assign(Object.assign({},yt(n.state,e,o.from,o.to)),{annotations:q.of(t.completion)})):e(n,t.completion,o.from,o.to),!0):!1}const xe=pe(g,ot);function $(n,t="option"){return e=>{let o=e.state.field(g,!1);if(!o||!o.open||o.open.disabled||Date.now()-o.open.timestamp<e.state.facet(m).interactionDelay)return!1;let s=1,i;t=="page"&&(i=pt(e,o.open.tooltip))&&(s=Math.max(2,Math.floor(i.dom.offsetHeight/i.dom.querySelector("li").offsetHeight)-1));let{length:r}=o.open.options,l=o.open.selected>-1?o.open.selected+s*(n?1:-1):n?0:r-1;return l<0?l=t=="page"?0:r-1:l>=r&&(l=t=="page"?r-1:0),e.dispatch({effects:nt.of(l)}),!0}}const Dt=n=>{let t=n.state.field(g,!1);return n.state.readOnly||!t||!t.open||t.open.selected<0||t.open.disabled||Date.now()-t.open.timestamp<n.state.facet(m).interactionDelay?!1:ot(n,t.open.options[t.open.selected])},st=n=>n.state.field(g,!1)?(n.dispatch({effects:H.of(!0)}),!0):!1,Ot=n=>{let t=n.state.field(g,!1);return!t||!t.active.some(e=>e.state!=0)?!1:(n.dispatch({effects:M.of(null)}),!0)};class Ce{constructor(t,e){this.active=t,this.context=e,this.time=Date.now(),this.updates=[],this.done=void 0}}const Ie=50,ke=1e3,De=ee.fromClass(class{constructor(n){this.view=n,this.debounceUpdate=-1,this.running=[],this.debounceAccept=-1,this.pendingStart=!1,this.composing=0;for(let t of n.state.field(g).active)t.isPending&&this.startQuery(t)}update(n){let t=n.state.field(g),e=n.state.facet(m);if(!n.selectionSet&&!n.docChanged&&n.startState.field(g)==t)return;let o=n.transactions.some(i=>{let r=kt(i,e);return r&8||(i.selection||i.docChanged)&&!(r&3)});for(let i=0;i<this.running.length;i++){let r=this.running[i];if(o||r.context.abortOnDocChange&&n.docChanged||r.updates.length+n.transactions.length>Ie&&Date.now()-r.time>ke){for(let l of r.context.abortListeners)try{l()}catch(a){Z(this.view.state,a)}r.context.abortListeners=null,this.running.splice(i--,1)}else r.updates.push(...n.transactions)}this.debounceUpdate>-1&&clearTimeout(this.debounceUpdate),n.transactions.some(i=>i.effects.some(r=>r.is(H)))&&(this.pendingStart=!0);let s=this.pendingStart?50:e.activateOnTypingDelay;if(this.debounceUpdate=t.active.some(i=>i.isPending&&!this.running.some(r=>r.active.source==i.source))?setTimeout(()=>this.startUpdate(),s):-1,this.composing!=0)for(let i of n.transactions)i.isUserEvent("input.type")?this.composing=2:this.composing==2&&i.selection&&(this.composing=3)}startUpdate(){this.debounceUpdate=-1,this.pendingStart=!1;let{state:n}=this.view,t=n.field(g);for(let e of t.active)e.isPending&&!this.running.some(o=>o.active.source==e.source)&&this.startQuery(e);this.running.length&&t.open&&t.open.disabled&&(this.debounceAccept=setTimeout(()=>this.accept(),this.view.state.facet(m).updateSyncTime))}startQuery(n){let{state:t}=this.view,e=O(t),o=new _(t,e,n.explicit,this.view),s=new Ce(n,o);this.running.push(s),Promise.resolve(n.source(o)).then(i=>{s.context.aborted||(s.done=i||null,this.scheduleAccept())},i=>{this.view.dispatch({effects:M.of(null)}),Z(this.view.state,i)})}scheduleAccept(){this.running.every(n=>n.done!==void 0)?this.accept():this.debounceAccept<0&&(this.debounceAccept=setTimeout(()=>this.accept(),this.view.state.facet(m).updateSyncTime))}accept(){var n;this.debounceAccept>-1&&clearTimeout(this.debounceAccept),this.debounceAccept=-1;let t=[],e=this.view.state.facet(m),o=this.view.state.field(g);for(let s=0;s<this.running.length;s++){let i=this.running[s];if(i.done===void 0)continue;if(this.running.splice(s--,1),i.done){let l=O(i.updates.length?i.updates[0].startState:this.view.state),a=Math.min(l,i.done.from+(i.active.explicit?0:1)),f=new L(i.active.source,i.active.explicit,a,i.done,i.done.from,(n=i.done.to)!==null&&n!==void 0?n:l);for(let c of i.updates)f=f.update(c,e);if(f.hasResult()){t.push(f);continue}}let r=o.active.find(l=>l.source==i.active.source);if(r&&r.isPending)if(i.done==null){let l=new x(i.active.source,0);for(let a of i.updates)l=l.update(a,e);l.isPending||t.push(l)}else this.startQuery(r)}(t.length||o.open&&o.open.disabled)&&this.view.dispatch({effects:et.of(t)})}},{eventHandlers:{blur(n){let t=this.view.state.field(g,!1);if(t&&t.tooltip&&this.view.state.facet(m).closeOnBlur){let e=t.open&&pt(this.view,t.open.tooltip);(!e||!e.dom.contains(n.relatedTarget))&&setTimeout(()=>this.view.dispatch({effects:M.of(null)}),10)}},compositionstart(){this.composing=1},compositionend(){this.composing==3&&setTimeout(()=>this.view.dispatch({effects:H.of(!1)}),20),this.composing=0}}}),Oe=typeof navigator=="object"&&/Win/.test(navigator.platform),Se=Y.highest(E.domEventHandlers({keydown(n,t){let e=t.state.field(g,!1);if(!e||!e.open||e.open.disabled||e.open.selected<0||n.key.length>1||n.ctrlKey&&!(Oe&&n.altKey)||n.metaKey)return!1;let o=e.open.options[e.open.selected],s=e.active.find(r=>r.source==o.source),i=o.completion.commitCharacters||s.result.commitCharacters;return i&&i.indexOf(n.key)>-1&&ot(t,o),!1}})),St=E.baseTheme({".cm-tooltip.cm-tooltip-autocomplete":{"& > ul":{fontFamily:"monospace",whiteSpace:"nowrap",overflow:"hidden auto",maxWidth_fallback:"700px",maxWidth:"min(700px, 95vw)",minWidth:"250px",maxHeight:"10em",height:"100%",listStyle:"none",margin:0,padding:0,"& > li, & > completion-section":{padding:"1px 3px",lineHeight:1.2},"& > li":{overflowX:"hidden",textOverflow:"ellipsis",cursor:"pointer"},"& > completion-section":{display:"list-item",borderBottom:"1px solid silver",paddingLeft:"0.5em",opacity:.7}}},"&light .cm-tooltip-autocomplete ul li[aria-selected]":{background:"#17c",color:"white"},"&light .cm-tooltip-autocomplete-disabled ul li[aria-selected]":{background:"#777"},"&dark .cm-tooltip-autocomplete ul li[aria-selected]":{background:"#347",color:"white"},"&dark .cm-tooltip-autocomplete-disabled ul li[aria-selected]":{background:"#444"},".cm-completionListIncompleteTop:before, .cm-completionListIncompleteBottom:after":{content:'"\xB7\xB7\xB7"',opacity:.5,display:"block",textAlign:"center"},".cm-tooltip.cm-completionInfo":{position:"absolute",padding:"3px 9px",width:"max-content",maxWidth:"400px",boxSizing:"border-box",whiteSpace:"pre-line"},".cm-completionInfo.cm-completionInfo-left":{right:"100%"},".cm-completionInfo.cm-completionInfo-right":{left:"100%"},".cm-completionInfo.cm-completionInfo-left-narrow":{right:"30px"},".cm-completionInfo.cm-completionInfo-right-narrow":{left:"30px"},"&light .cm-snippetField":{backgroundColor:"#00000022"},"&dark .cm-snippetField":{backgroundColor:"#ffffff22"},".cm-snippetFieldPosition":{verticalAlign:"text-top",width:0,height:"1.15em",display:"inline-block",margin:"0 -0.7px -.7em",borderLeft:"1.4px dotted #888"},".cm-completionMatchedText":{textDecoration:"underline"},".cm-completionDetail":{marginLeft:"0.5em",fontStyle:"italic"},".cm-completionIcon":{fontSize:"90%",width:".8em",display:"inline-block",textAlign:"center",paddingRight:".6em",opacity:"0.6",boxSizing:"content-box"},".cm-completionIcon-function, .cm-completionIcon-method":{"&:after":{content:"'\u0192'"}},".cm-completionIcon-class":{"&:after":{content:"'\u25CB'"}},".cm-completionIcon-interface":{"&:after":{content:"'\u25CC'"}},".cm-completionIcon-variable":{"&:after":{content:"'\u{1D465}'"}},".cm-completionIcon-constant":{"&:after":{content:"'\u{1D436}'"}},".cm-completionIcon-type":{"&:after":{content:"'\u{1D461}'"}},".cm-completionIcon-enum":{"&:after":{content:"'\u222A'"}},".cm-completionIcon-property":{"&:after":{content:"'\u25A1'"}},".cm-completionIcon-keyword":{"&:after":{content:"'\u{1F511}\uFE0E'"}},".cm-completionIcon-namespace":{"&:after":{content:"'\u25A2'"}},".cm-completionIcon-text":{"&:after":{content:"'abc'",fontSize:"50%",verticalAlign:"middle"}}});class Te{constructor(t,e,o,s){this.field=t,this.line=e,this.from=o,this.to=s}}class ct{constructor(t,e,o){this.field=t,this.from=e,this.to=o}map(t){let e=t.mapPos(this.from,-1,G.TrackDel),o=t.mapPos(this.to,1,G.TrackDel);return e==null||o==null?null:new ct(this.field,e,o)}}class ft{constructor(t,e){this.lines=t,this.fieldPositions=e}instantiate(t,e){let o=[],s=[e],i=t.doc.lineAt(e),r=/^\s*/.exec(i.text)[0];for(let a of this.lines){if(o.length){let f=r,c=/^\t*/.exec(a)[0].length;for(let h=0;h<c;h++)f+=t.facet(oe);s.push(e+f.length-c),a=f+a.slice(c)}o.push(a),e+=a.length+1}let l=this.fieldPositions.map(a=>new ct(a.field,s[a.line]+a.from,s[a.line]+a.to));return{text:o,ranges:l}}static parse(t){let e=[],o=[],s=[],i;for(let r of t.split(/\r\n?|\n/)){for(;i=/[#$]\{(?:(\d+)(?::([^}]*))?|((?:\\[{}]|[^}])*))\}/.exec(r);){let l=i[1]?+i[1]:null,a=i[2]||i[3]||"",f=-1,c=a.replace(/\\[{}]/g,h=>h[1]);for(let h=0;h<e.length;h++)(l!=null?e[h].seq==l:c&&e[h].name==c)&&(f=h);if(f<0){let h=0;for(;h<e.length&&(l==null||e[h].seq!=null&&e[h].seq<l);)h++;e.splice(h,0,{seq:l,name:c}),f=h;for(let u of s)u.field>=f&&u.field++}s.push(new Te(f,o.length,i.index,i.index+c.length)),r=r.slice(0,i.index)+a+r.slice(i.index+i[0].length)}r=r.replace(/\\([{}])/g,(l,a,f)=>{for(let c of s)c.line==o.length&&c.from>f&&(c.from--,c.to--);return a}),o.push(r)}return new ft(o,s)}}let Ae=U.widget({widget:new class extends ne{toDOM(){let n=document.createElement("span");return n.className="cm-snippetFieldPosition",n}ignoreEvent(){return!1}}}),Ee=U.mark({class:"cm-snippetField"});class P{constructor(t,e){this.ranges=t,this.active=e,this.deco=U.set(t.map(o=>(o.from==o.to?Ae:Ee).range(o.from,o.to)))}map(t){let e=[];for(let o of this.ranges){let s=o.map(t);if(!s)return null;e.push(s)}return new P(e,this.active)}selectionInsideField(t){return t.ranges.every(e=>this.ranges.some(o=>o.field==this.active&&o.from<=e.from&&o.to>=e.to))}}const N=k.define({map(n,t){return n&&n.map(t)}}),Be=k.define(),S=X.define({create(){return null},update(n,t){for(let e of t.effects){if(e.is(N))return e.value;if(e.is(Be)&&n)return new P(n.ranges,e.value)}return n&&t.docChanged&&(n=n.map(t.changes)),n&&t.selection&&!n.selectionInsideField(t.selection)&&(n=null),n},provide:n=>E.decorations.from(n,t=>t?t.deco:U.none)});function it(n,t){return w.create(n.filter(e=>e.field==t).map(e=>w.range(e.from,e.to)))}function Tt(n){let t=ft.parse(n);return(e,o,s,i)=>{let{text:r,ranges:l}=t.instantiate(e.state,s),{main:a}=e.state.selection,f={changes:{from:s,to:i==a.from?a.to:i,insert:Zt.of(r)},scrollIntoView:!0,annotations:o?[q.of(o),Jt.userEvent.of("input.complete")]:void 0};if(l.length&&(f.selection=it(l,0)),l.some(c=>c.field>0)){let c=new P(l,0),h=f.effects=[N.of(c)];e.state.field(S,!1)===void 0&&h.push(k.appendConfig.of([S,Re,$e,St]))}e.dispatch(e.state.update(f))}}function At(n){return({state:t,dispatch:e})=>{let o=t.field(S,!1);if(!o||n<0&&o.active==0)return!1;let s=o.active+n,i=n>0&&!o.ranges.some(r=>r.field==s+n);return e(t.update({selection:it(o.ranges,s),effects:N.of(i?null:new P(o.ranges,s)),scrollIntoView:!0})),!0}}const Et=({state:n,dispatch:t})=>n.field(S,!1)?(t(n.update({effects:N.of(null)})),!0):!1,Bt=At(1),Pt=At(-1);function Pe(n){let t=n.field(S,!1);return!!(t&&t.ranges.some(e=>e.field==t.active+1))}function Le(n){let t=n.field(S,!1);return!!(t&&t.active>0)}const Fe=[{key:"Tab",run:Bt,shift:Pt},{key:"Escape",run:Et}],lt=ht.define({combine(n){return n.length?n[0]:Fe}}),Re=Y.highest(dt.compute([lt],n=>n.facet(lt)));function Me(n,t){return Object.assign(Object.assign({},t),{apply:Tt(n)})}const $e=E.domEventHandlers({mousedown(n,t){let e=t.state.field(S,!1),o;if(!e||(o=t.posAtCoords({x:n.clientX,y:n.clientY}))==null)return!1;let s=e.ranges.find(i=>i.from<=o&&i.to>=o);return!s||s.field==e.active?!1:(t.dispatch({selection:it(e.ranges,s.field),effects:N.of(e.ranges.some(i=>i.field>s.field)?new P(e.ranges,s.field):null),scrollIntoView:!0}),!0)}});function Ne(n){let t=n.replace(/[\]\-\\]/g,"\\$&");try{return new RegExp(`[\\p{Alphabetic}\\p{Number}_${t}]+`,"ug")}catch{return new RegExp(`[w${t}]`,"g")}}function Lt(n,t){return new RegExp(t(n.source),n.unicode?"u":"")}const Ft=Object.create(null);function je(n){return Ft[n]||(Ft[n]=new WeakMap)}function Rt(n,t,e,o,s){for(let i=n.iterLines(),r=0;!i.next().done;){let{value:l}=i,a;for(t.lastIndex=0;a=t.exec(l);)if(!o[a[0]]&&r+a.index!=s&&(e.push({type:"text",label:a[0]}),o[a[0]]=!0,e.length>=2e3))return;r+=l.length+1}}function Mt(n,t,e,o,s){let i=n.length>=1e3,r=i&&t.get(n);if(r)return r;let l=[],a=Object.create(null);if(n.children){let f=0;for(let c of n.children){if(c.length>=1e3)for(let h of Mt(c,t,e,o-f,s-f))a[h.label]||(a[h.label]=!0,l.push(h));else Rt(c,e,l,a,s-f);f+=c.length+1}}else Rt(n,e,l,a,s);return i&&l.length<2e3&&t.set(n,l),l}const We=n=>{let t=n.state.languageDataAt("wordChars",n.pos).join(""),e=Ne(t),o=n.matchBefore(Lt(e,r=>r+"$"));if(!o&&!n.explicit)return null;let s=o?o.from:n.pos,i=Mt(n.state.doc,je(t),e,5e4,s);return{from:s,options:i,validFor:Lt(e,r=>"^"+r)}},j={brackets:["(","[","{","'",'"'],before:")]}:;>",stringPrefixes:[]},T=k.define({map(n,t){return t.mapPos(n,-1,G.TrackAfter)??void 0}}),rt=new class extends Yt{};rt.startSide=1,rt.endSide=-1;const $t=X.define({create(){return Gt.empty},update(n,t){if(n=n.map(t.changes),t.selection){let e=t.state.doc.lineAt(t.selection.main.head);n=n.update({filter:o=>o>=e.from&&o<=e.to})}for(let e of t.effects)e.is(T)&&(n=n.update({add:[rt.range(e.value,e.value+1)]}));return n}});function Ue(){return[He,$t]}const at="()[]{}<>\xAB\xBB\xBB\xAB\uFF3B\uFF3D\uFF5B\uFF5D";function Nt(n){for(let t=0;t<at.length;t+=2)if(at.charCodeAt(t)==n)return at.charAt(t+1);return ut(n<128?n:n+1)}function jt(n,t){return n.languageDataAt("closeBrackets",t)[0]||j}const qe=typeof navigator=="object"&&/Android\b/.test(navigator.userAgent),He=E.inputHandler.of((n,t,e,o)=>{if((qe?n.composing:n.compositionStarted)||n.state.readOnly)return!1;let s=n.state.selection.main;if(o.length>2||o.length==2&&D(C(o,0))==1||t!=s.from||e!=s.to)return!1;let i=Ut(n.state,o);return i?(n.dispatch(i),!0):!1}),Wt=({state:n,dispatch:t})=>{if(n.readOnly)return!1;let e=jt(n,n.selection.main.head).brackets||j.brackets,o=null,s=n.changeByRange(i=>{if(i.empty){let r=Ke(n.doc,i.head);for(let l of e)if(l==r&&V(n.doc,i.head)==Nt(C(l,0)))return{changes:{from:i.head-l.length,to:i.head+l.length},range:w.cursor(i.head-l.length)}}return{range:o=i}});return o||t(n.update(s,{scrollIntoView:!0,userEvent:"delete.backward"})),!o},Ve=[{key:"Backspace",run:Wt}];function Ut(n,t){let e=jt(n,n.selection.main.head),o=e.brackets||j.brackets;for(let s of o){let i=Nt(C(s,0));if(t==s)return i==s?Xe(n,s,o.indexOf(s+s+s)>-1,e):ze(n,s,i,e.before||j.before);if(t==i&&qt(n,n.selection.main.from))return Qe(n,s,i)}return null}function qt(n,t){let e=!1;return n.field($t).between(0,n.doc.length,o=>{o==t&&(e=!0)}),e}function V(n,t){let e=n.sliceString(t,t+2);return e.slice(0,D(C(e,0)))}function Ke(n,t){let e=n.sliceString(t-2,t);return D(C(e,0))==e.length?e:e.slice(1)}function ze(n,t,e,o){let s=null,i=n.changeByRange(r=>{if(!r.empty)return{changes:[{insert:t,from:r.from},{insert:e,from:r.to}],effects:T.of(r.to+t.length),range:w.range(r.anchor+t.length,r.head+t.length)};let l=V(n.doc,r.head);return!l||/\s/.test(l)||o.indexOf(l)>-1?{changes:{insert:t+e,from:r.head},effects:T.of(r.head+t.length),range:w.cursor(r.head+t.length)}:{range:s=r}});return s?null:n.update(i,{scrollIntoView:!0,userEvent:"input.type"})}function Qe(n,t,e){let o=null,s=n.changeByRange(i=>i.empty&&V(n.doc,i.head)==e?{changes:{from:i.head,to:i.head+e.length,insert:e},range:w.cursor(i.head+e.length)}:o={range:i});return o?null:n.update(s,{scrollIntoView:!0,userEvent:"input.type"})}function Xe(n,t,e,o){let s=o.stringPrefixes||j.stringPrefixes,i=null,r=n.changeByRange(l=>{if(!l.empty)return{changes:[{insert:t,from:l.from},{insert:t,from:l.to}],effects:T.of(l.to+t.length),range:w.range(l.anchor+t.length,l.head+t.length)};let a=l.head,f=V(n.doc,a),c;if(f==t){if(Ht(n,a))return{changes:{insert:t+t,from:a},effects:T.of(a+t.length),range:w.cursor(a+t.length)};if(qt(n,a)){let h=e&&n.sliceDoc(a,a+t.length*3)==t+t+t?t+t+t:t;return{changes:{from:a,to:a+h.length,insert:h},range:w.cursor(a+h.length)}}}else{if(e&&n.sliceDoc(a-2*t.length,a)==t+t&&(c=Vt(n,a-2*t.length,s))>-1&&Ht(n,c))return{changes:{insert:t+t+t+t,from:a},effects:T.of(a+t.length),range:w.cursor(a+t.length)};if(n.charCategorizer(a)(f)!=J.Word&&Vt(n,a,s)>-1&&!Ye(n,a,t,s))return{changes:{insert:t+t,from:a},effects:T.of(a+t.length),range:w.cursor(a+t.length)}}return{range:i=l}});return i?null:n.update(r,{scrollIntoView:!0,userEvent:"input.type"})}function Ht(n,t){let e=R(n).resolveInner(t+1);return e.parent&&e.from==t}function Ye(n,t,e,o){let s=R(n).resolveInner(t,-1),i=o.reduce((r,l)=>Math.max(r,l.length),0);for(let r=0;r<5;r++){let l=n.sliceDoc(s.from,Math.min(s.to,s.from+e.length+i)),a=l.indexOf(e);if(!a||a>-1&&o.indexOf(l.slice(0,a))>-1){let c=s.firstChild;for(;c&&c.from==s.from&&c.to-c.from>e.length+a;){if(n.sliceDoc(c.to-e.length,c.to)==e)return!1;c=c.firstChild}return!0}let f=s.to==t&&s.parent;if(!f)break;s=f}return!1}function Vt(n,t,e){let o=n.charCategorizer(t);if(o(n.sliceDoc(t-1,t))!=J.Word)return t;for(let s of e){let i=t-s.length;if(n.sliceDoc(i,t)==s&&o(n.sliceDoc(i-1,i))!=J.Word)return i}return-1}function Ge(n={}){return[Se,g,m.of(n),De,Je,St]}const Kt=[{key:"Ctrl-Space",run:st},{mac:"Alt-`",run:st},{key:"Escape",run:Ot},{key:"ArrowDown",run:$(!0)},{key:"ArrowUp",run:$(!1)},{key:"PageDown",run:$(!0,"page")},{key:"PageUp",run:$(!1,"page")},{key:"Enter",run:Dt}],Je=Y.highest(dt.computeN([m],n=>n.facet(m).defaultKeymap?[Kt]:[]));function Ze(n){let t=n.field(g,!1);return t&&t.active.some(e=>e.isPending)?"pending":t&&t.active.some(e=>e.state!=0)?"active":null}const zt=new WeakMap;function _e(n){var t;let e=(t=n.field(g,!1))===null||t===void 0?void 0:t.open;if(!e||e.disabled)return[];let o=zt.get(e.options);return o||zt.set(e.options,o=e.options.map(s=>s.completion)),o}function tn(n){var t;let e=(t=n.field(g,!1))===null||t===void 0?void 0:t.open;return e&&!e.disabled&&e.selected>=0?e.options[e.selected].completion:null}function en(n){var t;let e=(t=n.field(g,!1))===null||t===void 0?void 0:t.open;return e&&!e.disabled&&e.selected>=0?e.selected:null}function nn(n){return nt.of(n)}export{_ as CompletionContext,Dt as acceptCompletion,Ge as autocompletion,Et as clearSnippet,Ue as closeBrackets,Ve as closeBracketsKeymap,Ot as closeCompletion,We as completeAnyWord,gt as completeFromList,Kt as completionKeymap,Ze as completionStatus,_e as currentCompletions,Wt as deleteBracketPair,Pe as hasNextSnippetField,Le as hasPrevSnippetField,ie as ifIn,le as ifNotIn,Ut as insertBracket,yt as insertCompletionText,$ as moveCompletionSelection,Bt as nextSnippetField,q as pickedCompletion,Pt as prevSnippetField,tn as selectedCompletion,en as selectedCompletionIndex,nn as setSelectedCompletion,Tt as snippet,Me as snippetCompletion,lt as snippetKeymap,st as startCompletion};
